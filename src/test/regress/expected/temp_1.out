--
-- TEMP
-- Test temp relations and indexes
--
-- test temp table/index masking
CREATE TABLE temptest(col int);
CREATE INDEX i_temptest ON temptest(col);
CREATE TEMP TABLE temptest(tcol int);
ERROR:  PG-XC does not yet support temporary tables
CREATE INDEX i_temptest ON temptest(tcol);
ERROR:  column "tcol" does not exist
SELECT * FROM temptest;
 col 
-----
(0 rows)

DROP INDEX i_temptest;
DROP TABLE temptest;
SELECT * FROM temptest;
ERROR:  relation "temptest" does not exist
LINE 1: SELECT * FROM temptest;
                      ^
DROP INDEX i_temptest;
ERROR:  index "i_temptest" does not exist
DROP TABLE temptest;
ERROR:  table "temptest" does not exist
-- test temp table selects
CREATE TABLE temptest(col int);
INSERT INTO temptest VALUES (1);
CREATE TEMP TABLE temptest(tcol float);
ERROR:  PG-XC does not yet support temporary tables
INSERT INTO temptest VALUES (2.1);
SELECT * FROM temptest;
 col 
-----
   1
   2
(2 rows)

DROP TABLE temptest;
SELECT * FROM temptest;
ERROR:  relation "temptest" does not exist
LINE 1: SELECT * FROM temptest;
                      ^
DROP TABLE temptest;
ERROR:  table "temptest" does not exist
-- test temp table deletion
CREATE TEMP TABLE temptest(col int);
ERROR:  PG-XC does not yet support temporary tables
\c
SELECT * FROM temptest;
ERROR:  relation "temptest" does not exist
LINE 1: SELECT * FROM temptest;
                      ^
-- Test ON COMMIT DELETE ROWS
CREATE TEMP TABLE temptest(col int) ON COMMIT DELETE ROWS;
ERROR:  PG-XC does not yet support temporary tables
BEGIN;
INSERT INTO temptest VALUES (1);
ERROR:  relation "temptest" does not exist
LINE 1: INSERT INTO temptest VALUES (1);
                    ^
INSERT INTO temptest VALUES (2);
ERROR:  current transaction is aborted, commands ignored until end of transaction block
SELECT * FROM temptest  ORDER BY 1;
ERROR:  current transaction is aborted, commands ignored until end of transaction block
COMMIT;
SELECT * FROM temptest;
ERROR:  relation "temptest" does not exist
LINE 1: SELECT * FROM temptest;
                      ^
DROP TABLE temptest;
ERROR:  table "temptest" does not exist
BEGIN;
CREATE TEMP TABLE temptest(col) ON COMMIT DELETE ROWS AS SELECT 1;
ERROR:  INTO clause not yet supported
SELECT * FROM temptest;
ERROR:  current transaction is aborted, commands ignored until end of transaction block
COMMIT;
SELECT * FROM temptest;
ERROR:  relation "temptest" does not exist
LINE 1: SELECT * FROM temptest;
                      ^
DROP TABLE temptest;
ERROR:  table "temptest" does not exist
-- Test ON COMMIT DROP
BEGIN;
CREATE TEMP TABLE temptest(col int) ON COMMIT DROP;
ERROR:  PG-XC does not yet support temporary tables
INSERT INTO temptest VALUES (1);
ERROR:  current transaction is aborted, commands ignored until end of transaction block
INSERT INTO temptest VALUES (2);
ERROR:  current transaction is aborted, commands ignored until end of transaction block
SELECT * FROM temptest ORDER BY 1;
ERROR:  current transaction is aborted, commands ignored until end of transaction block
COMMIT;
SELECT * FROM temptest;
ERROR:  relation "temptest" does not exist
LINE 1: SELECT * FROM temptest;
                      ^
BEGIN;
CREATE TEMP TABLE temptest(col) ON COMMIT DROP AS SELECT 1;
ERROR:  INTO clause not yet supported
SELECT * FROM temptest;
ERROR:  current transaction is aborted, commands ignored until end of transaction block
COMMIT;
SELECT * FROM temptest;
ERROR:  relation "temptest" does not exist
LINE 1: SELECT * FROM temptest;
                      ^
-- ON COMMIT is only allowed for TEMP
CREATE TABLE temptest(col int) ON COMMIT DELETE ROWS;
ERROR:  ON COMMIT can only be used on temporary tables
CREATE TABLE temptest(col) ON COMMIT DELETE ROWS AS SELECT 1;
ERROR:  INTO clause not yet supported
-- Test foreign keys
BEGIN;
CREATE TEMP TABLE temptest1(col int PRIMARY KEY);
ERROR:  PG-XC does not yet support temporary tables
CREATE TEMP TABLE temptest2(col int REFERENCES temptest1)
  ON COMMIT DELETE ROWS;
ERROR:  current transaction is aborted, commands ignored until end of transaction block
INSERT INTO temptest1 VALUES (1);
ERROR:  current transaction is aborted, commands ignored until end of transaction block
INSERT INTO temptest2 VALUES (1);
ERROR:  current transaction is aborted, commands ignored until end of transaction block
COMMIT;
SELECT * FROM temptest1;
ERROR:  relation "temptest1" does not exist
LINE 1: SELECT * FROM temptest1;
                      ^
SELECT * FROM temptest2;
ERROR:  relation "temptest2" does not exist
LINE 1: SELECT * FROM temptest2;
                      ^
BEGIN;
CREATE TEMP TABLE temptest3(col int PRIMARY KEY) ON COMMIT DELETE ROWS;
ERROR:  PG-XC does not yet support temporary tables
CREATE TEMP TABLE temptest4(col int REFERENCES temptest3);
ERROR:  current transaction is aborted, commands ignored until end of transaction block
COMMIT;
-- Test manipulation of temp schema's placement in search path
create table public.whereami (f1 text);
insert into public.whereami values ('public');
create temp table whereami (f1 text);
ERROR:  PG-XC does not yet support temporary tables
insert into whereami values ('temp');
create function public.whoami() returns text
  as $$select 'public'::text$$ language sql;
create function pg_temp.whoami() returns text
  as $$select 'temp'::text$$ language sql;
-- default should have pg_temp implicitly first, but only for tables
select * from whereami;
  f1  
------
 temp
(1 row)

select whoami();
 whoami 
--------
 public
(1 row)

-- can list temp first explicitly, but it still doesn't affect functions
set search_path = pg_temp, public;
select * from whereami;
  f1  
------
 temp
(1 row)

select whoami();
 whoami 
--------
 public
(1 row)

-- or put it last for security
set search_path = public, pg_temp;
select * from whereami;
   f1   
--------
 public
(1 row)

select whoami();
 whoami 
--------
 public
(1 row)

-- you can invoke a temp function explicitly, though
select pg_temp.whoami();
 whoami 
--------
 temp
(1 row)

drop table public.whereami;
